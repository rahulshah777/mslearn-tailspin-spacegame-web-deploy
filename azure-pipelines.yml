trigger:
  - "*"

variables:
  buildConfiguration: "Release"
  solution: "src/ADOGenerator/ADOGenerator.csproj"

stages:
- stage: Build
  displayName: "Build ADOGenerator Console App"
  jobs:
  - job: BuildJob
    pool:
      vmImage: ubuntu-latest

    steps:
    - checkout: self
    
    - task: UseDotNet@2
      inputs:
        packageType: sdk
        version: "8.0.x"
    
    - task: DotNetCoreCLI@2
      displayName: Restore
      inputs:
        command: restore
        projects: "$(solution)"
    
    - task: DotNetCoreCLI@2
      displayName: Build
      inputs:
        command: build
        projects: "$(solution)"
        arguments: "--configuration $(buildConfiguration)"
    
    - task: DotNetCoreCLI@2
      displayName: Publish
      inputs:
        command: publish
        projects: "$(solution)"
        arguments: "--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)"
        zipAfterPublish: true

    - publish: "$(Build.ArtifactStagingDirectory)"
      artifact: drop


# ===========================
# DEV STAGE
# ===========================
- stage: Dev
  displayName: "Deploy to Dev App Service"
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: DevDeploy
    displayName: "Deploy to Dev environment"
    environment: "dev"       # Azure Pipelines environment
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop

          - task: AzureWebApp@1
            displayName: "Deploy to Dev Web App"
            inputs:
              azureSubscription: "Resource Manager - Tailspin - Space Game"
              appType: "webAppLinux"
              appName: "$(WebAppNameDev)"
              package: "$(Pipeline.Workspace)/drop/**/*.zip"

# ===========================
# TEST STAGE
# ===========================
- stage: Test
  displayName: "Deploy to Test App Service"
  dependsOn: Dev
  condition: succeeded()
  jobs:
  - deployment: TestDeploy
    displayName: "Deploy to Test environment"
    environment: "test"
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop

          - task: AzureWebApp@1
            displayName: "Deploy to Test Web App"
            inputs:
              azureSubscription: "Resource Manager - Tailspin - Space Game"
              appType: "webAppLinux"
              appName: "$(WebAppNameTest)"
              package: "$(Pipeline.Workspace)/drop/**/*.zip"

# ===========================
# STAGING STAGE
# ===========================
- stage: Staging
  displayName: "Deploy to Staging App Service"
  dependsOn: Test
  condition: succeeded()
  jobs:
  - deployment: StagingDeploy
    displayName: "Deploy to Staging environment"
    environment: "staging"
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop

          - task: AzureWebApp@1
            displayName: "Deploy to Staging Web App"
            inputs:
              azureSubscription: "Resource Manager - Tailspin - Space Game"
              appType: "webAppLinux"
              appName: "$(WebAppNameStaging)"
              package: "$(Pipeline.Workspace)/drop/**/*.zip"

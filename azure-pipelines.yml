trigger:
- "*"

variables:
  buildConfiguration: "Release"
  solution: "src/ADOGenerator.sln"

schedules:
- cron: "0 3 * * *"
  displayName: "Build every day at 3 A.M."
  branches:
    include:
    - release
  always: false

stages:
- stage: "Build"
  displayName: "Build the ADOGenerator solution"
  jobs:
  - job: "Build"
    displayName: "Build job"
    pool:
      vmImage: "ubuntu-latest"

    variables:
      dotnetSdkVersion: "8.0.x"

    steps:
    - task: UseDotNet@2
      displayName: "Use .NET SDK $(dotnetSdkVersion)"
      inputs:
        version: "$(dotnetSdkVersion)"

    - task: DotNetCoreCLI@2
      displayName: "Restore project dependencies"
      inputs:
        command: "restore"
        projects: "$(solution)"

    - task: DotNetCoreCLI@2
      displayName: "Build the project - $(buildConfiguration)"
      inputs:
        command: "build"
        projects: "$(solution)"
        arguments: "--no-restore --configuration $(buildConfiguration)"

    - task: DotNetCoreCLI@2
      displayName: "Publish ADOGenerator - $(buildConfiguration)"
      inputs:
        command: "publish"
        projects: "src/ADOGenerator/ADOGenerator.csproj"
        publishWebProjects: false
        arguments: "--no-build --configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/$(buildConfiguration)"
        zipAfterPublish: true

    - publish: "$(Build.ArtifactStagingDirectory)"
      artifact: drop

- stage: "Dev"
  displayName: "Dev stage (placeholder deploy)"
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: "DevJob"
    displayName: "Simulated Dev deploy"
    pool:
      vmImage: "ubuntu-latest"
    steps:
    - download: current
      artifact: drop
    - script: |
        echo "Simulating deployment of ADOGenerator to Dev environment..."
        ls -R $(Pipeline.Workspace)/drop
      displayName: "Show published artifacts for Dev"

- stage: "Test"
  displayName: "Test stage (placeholder deploy)"
  dependsOn: Dev
  condition: succeeded()
  jobs:
  - job: "TestJob"
    displayName: "Simulated Test deploy"
    pool:
      vmImage: "ubuntu-latest"
    steps:
    - download: current
      artifact: drop
    - script: |
        echo "Simulating deployment of ADOGenerator to Test environment..."
        ls -R $(Pipeline.Workspace)/drop
      displayName: "Show published artifacts for Test"

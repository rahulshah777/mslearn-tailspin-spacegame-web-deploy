trigger:
- "*"

variables:
  buildConfiguration: "Release"
  solution: "src/ADOGenerator.sln"

schedules:
- cron: "0 3 * * *"
  displayName: "Build every day at 3 A.M."
  branches:
    include:
    - release
  always: false

stages:
- stage: "Build"
  displayName: "Build the ADOGenerator solution"
  jobs:
  - job: "Build"
    displayName: "Build job"
    pool:
      vmImage: "ubuntu-latest"

    variables:
      dotnetSdkVersion: "8.0.x"

    steps:
    - task: UseDotNet@2
      displayName: "Use .NET SDK $(dotnetSdkVersion)"
      inputs:
        version: "$(dotnetSdkVersion)"

    - task: DotNetCoreCLI@2
      displayName: "Restore project dependencies"
      inputs:
        command: "restore"
        projects: "$(solution)"

    - task: DotNetCoreCLI@2
      displayName: "Build the project - $(buildConfiguration)"
      inputs:
        command: "build"
        projects: "$(solution)"
        arguments: "--no-restore --configuration $(buildConfiguration)"

    - task: DotNetCoreCLI@2
      displayName: "Publish ADOGenerator - $(buildConfiguration)"
      inputs:
        command: "publish"
        projects: "src/ADOGenerator/ADOGenerator.csproj"
        publishWebProjects: false
        arguments: "--no-build --configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/$(buildConfiguration)"
        zipAfterPublish: true

    - publish: "$(Build.ArtifactStagingDirectory)"
      artifact: drop

- stage: "Dev"
  displayName: "Deploy to Dev App Service"
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: DevDeploy
    displayName: "Deploy to Dev environment"
    environment: "dev"
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop

          - task: AzureWebApp@1
            displayName: "Deploy to Dev Web App"
            inputs:
              azureSubscription: "Resource Manager - Tailspin - Space Game"
              appType: "webAppLinux"
              appName: "$(WebAppNameDev)"
              package: "$(Pipeline.Workspace)/drop/**/*.zip"


- stage: "Test"
  displayName: "Deploy to Test App Service"
  dependsOn: Dev
  condition: succeeded()
  jobs:
  - deployment: TestDeploy
    displayName: "Deploy to Test environment"
    environment: "test"
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop

          - task: AzureWebApp@1
            displayName: "Deploy to Test Web App"
            inputs:
              azureSubscription: "Resource Manager - Tailspin - Space Game"
              appType: "webAppLinux"
              appName: "$(WebAppNameTest)"
              package: "$(Pipeline.Workspace)/drop/**/*.zip"

